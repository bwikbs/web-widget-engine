<!DOCTYPE html>
<html>
	<head>
		<script src="./xml2json.js"></script>
		<script src="./js2xmlparser.js"></script>				
	</head>
	<body>
		<h1>input html code you want</h1>
		<h3> external links(.css, .js) are not supported.</h3>
		<form onsubmit="onSubmit()" action="#" id="form">
			<input type="submit">
			<br>
			<textarea rows="30" cols="80" id="code">
			</textarea>
			<h3>output</h3>
			<textarea rows="30" cols="80" id="result"></textarea>			
		</form>
		
		<script type="text/javascript" >
	
			function onSubmit() {
				if (document.querySelector("iframe")) 
					document.querySelector("iframe").parentElement.removeChild(document.querySelector("iframe"))
				var code = document.getElementById("code");

				var iframe = document.createElement("iframe");
				iframe.width = "360"
				iframe.height = "360"
				iframe.srcdoc = code.value;
				document.body.appendChild(iframe);		
				
				iframe.onload = function() {
					console.log("onload");
					function nameFromType(type) {
						switch(type) {
							case 1:
								return "element"
							case 9:
								return "document"
							case 10:
								return "documentType"
							case 8:
								return "comment"
							case 3:
								return "text"
							default:
								console.log("nodetype warning!!" + type)
								return "idontknow"
						}
					}
					var result = {
						"node" : {
						}
					}
					function process(node, into) {
						into["@"] = {
							"nodeType" : node.nodeType,
							"localName" : nameFromType(node.nodeType)
						}
						
						if (node.nodeType == 1) {
							into["@"].localName = node.localName;
							
							if(node.localName == "style") {
								// console.log(node)
								into.style = []
								var rules = node.sheet.cssRules;
								for(var i = 0; i < rules.length; i ++) {
									var selectorText = rules[i].selectorText;
									// console.log(selectorText)
									var st = {};
									st["@"] = {}
									st["@"].selectorText = selectorText
									for (var j = 0; j < rules[i].style.length; j ++) {
										// console.log(rules[i].style[j])
										// console.log(rules[i].style[rules[i].style[j]])
										d = rules[i]
										
										st["@"][rules[i].style[j]] = rules[i].style[rules[i].style[j]]
									}
									
									into.style.push(st);																		
								}
							}
							
							var attrs = node.attributes;
							for(var i = 0; i < attrs.length; i ++) {
								into["@"][attrs[i].name] = attrs[i].value;
							}
						} else if (node.nodeType == 3) {
							into["text"] = {"#":node.data};
						}
						
						into.node = [];
						var c = node.firstChild;
						while(c) {
							var t = {};
							process(c, t);
							Array.prototype.push.call(into.node, t);
							
							c = c.nextSibling;
						}
					}				
					process(iframe.contentDocument,result.node)
					console.log(result);
				
					var output = document.getElementById("result")
					//var x2js = new X2JS(); 
					//output.value = x2js.json2xml_str(result);
					output.value = js2xmlparser("HTMLDocument", result, {useCDATA:true})
									
					// document.body.removeChild(iframe);
				}
					
			}
		</script>
	</body>
</html>