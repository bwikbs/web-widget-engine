<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <style>
    .top {
        background: url("images/bg.jpg");
    }
    .subtitle {
        font-weight: bold;
        color: #3d89a1;
    }
    </style>
</head>
<body>
  <div class="circleWrapper">
    <div class="top" id="top">
        <div id="section" class="subtitle">
            YAWN, STRETCH, DRINK
        </div>
<!--         <img id="testimg" class="icon" src="images/icon.png" /> -->
    </div>
    <div id="title" class="contents">
        Your body loses water while you sleep. Have a glass or two to start the day.
    </div>
  </div>
</body>
<script>
   var MAX_NEWS_CNT = 5;

   var index=0;
   var news_json;
   var news_image = new Array(MAX_NEWS_CNT);
   var newsAPI = "http://api.nytimes.com/svc/topstories/v1/world.json?api-key=27a5c7578126917ce802fb341ab508c9:4:74367408";
   document.getElementsByTagName("body").item(0).onclick = function() {
      updateContent();
   };

   function updateContent(){
        var title_text = document.getElementById("title");
        var section_text = document.getElementById("section");
        var section_str = news_json['results'][index]['subsection'];
        var title_str = news_json['results'][index]['title'];

        title_text.textContent = title_str;
        section_text.textContent = section_str;

        if(news_json['results'][index]['multimedia'].length!=0){
          var imgUrl = news_json['results'][index]['multimedia'][0]['url'];
          if(news_image[index]==undefined){
            fetchImage(imgUrl,index);
          }else{
            updateImage(news_image[index]);
          }
        }else{
          print("NO Image!");

          var b = document.getElementById("top");
          b.style.backgroundImage="url(images/bg.jpg)";
          b.style.backgroundRepeat="no-repeat" ;
          b.style.backgroundSize="100%" ;

          news_image[index]=="";
        }

        index++;
        if(index>MAX_NEWS_CNT)
            index=0;
   }
   function fetch(){
      function onLoadHandler() {
        news_json = this.response;
        updateContent();
      }
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", onLoadHandler);
      xhr.open("GET",newsAPI);
      xhr.responseType='json';
      xhr.send();
   }
   function fetchImage(url,idx){
      function onLoadHandler() {
        print("Image Size: "+this.response.size);
        print("ContentType: "+this.response.type);
        var objURL = URL.createObjectURL(this.response);

        news_image[idx] = objURL;
        updateImage(objURL);

      }
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", onLoadHandler);
      xhr.open("GET",url);
      xhr.responseType='blob';
      xhr.send();
   }
   function updateImage(objURL){
      // var imgElement = document.getElementById("testimg");
      // imgElement.src = objURL;

      var b = document.getElementById("top");
      b.style.backgroundImage="url("+objURL+")";
      b.style.backgroundRepeat="no-repeat" ;
      b.style.backgroundSize="100%" ;
   }
   fetch();

</script>
</html>
